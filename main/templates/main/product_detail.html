{% extends 'main/base.html' %}
{% load shop_filters %}
{% block title %}{{ product.name }} ‚Äî –ú–∞–≥–∞–∑–∏–Ω{% endblock %}

{% block content %}
    <article class="product-detail">
        <div class="media">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
            {% else %}
                <div class="no-image lg">No image</div>
            {% endif %}
        </div>

        <div class="content">
            <h1>{{ product.name }}</h1>

            <div class="mini-rating">
                <span class="stars">{{ average_rating|default:0|floatformat:1 }}‚òÖ</span>
                <span>¬∑ {{ reviews_count }} –≤—ñ–¥–≥—É–∫—ñ–≤</span>
                {% if user.is_authenticated and not user_review %}
                    <span>¬∑</span>
                    <a class="link" href="{% url 'reviews:add_review' product.id %}">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</a>
                {% endif %}
            </div>

            <div class="meta">
                {% if product.category %}
                    <span>
                        –ö–∞—Ç–µ–≥–æ—Ä—ñ—è:
                        <a href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a>
                    </span>
                {% endif %}
                <span>–ü–µ—Ä–µ–≥–ª—è–¥–∏: {{ product.views }}</span>
                <span>–î–æ–¥–∞–Ω–æ: {{ product.created_at|time_ago }}</span>
            </div>

            {# –ë–ª–æ–∫ —Ü—ñ–Ω–∏ + –∑–Ω–∏–∂–∫–∏ #}
            <div class="price-block" style="margin-top: 12px;">
                {% if product.has_active_discount %}
                    {% include 'discounts/discount_badge.html' with product=product %}

                    <div class="price-old line-through text-gray-400">
                        {{ product.price|currency }}
                    </div>

                    <div class="price-new text-2xl font-bold text-red-600">
                        {{ product.get_discounted_price|currency }}
                    </div>
                {% else %}
                    <div class="price text-2xl font-bold">
                        –¶—ñ–Ω–∞: <b>{{ product.price|currency }}</b>
                    </div>
                {% endif %}
            </div>


            {% if product.featured %}
                <div class="featured-badge">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π</div>
            {% endif %}

            <div class="desc">
                {{ product.description|linebreaks }}
            </div>

            {% if product.detailed_description %}
                <section class="product-rich">
                    <h2 style="margin-top:16px;">–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å</h2>
                    <div class="prose prose-lg max-w-none">
                        {{ product.detailed_description|safe }}
                    </div>
                </section>
            {% endif %}

            {# –î—ñ—ó: –±–µ–∑ –∫–æ—à–∏–∫–∞, –ø—Ä–æ—Å—Ç–∞ –ø–æ–∫—É–ø–∫–∞ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –ø—Ä–æ–º–æ–∫–æ–¥—É –≤ —Å–µ—Å—ñ—ó #}
            <div class="actions">
                <form action="{% url 'cart:cart_add' product.id %}" method="post"
                      class="inline-flex gap-4 items-center">
                    {% csrf_token %}
                    {{ cart_product_form.quantity }}
                    {{ cart_product_form.override }}
                    <button type="submit" class="btn">
                        üõí –î–æ–¥–∞—Ç–∏ –¥–æ –∫–æ—à–∏–∫–∞
                    </button>
                </form>

                <a class="btn ghost" href="{% url 'main:product_list' %}">
                    –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É
                </a>
            </div>

            {% include 'reviews/review_list.html' %}
    </article>

    {% if related_products %}
        <section class="related-products">
            <h2>–°—Ö–æ–∂—ñ —Ç–æ–≤–∞—Ä–∏</h2>
            <div class="related-grid">
                {% for p in related_products %}
                    <article class="product-card small">
                        {% if p.image %}
                            <a class="thumb" href="{{ p.get_absolute_url }}">
                                <img src="{{ p.image.url }}" alt="{{ p.name }}">
                            </a>
                        {% else %}
                            <a class="thumb no-image" href="{{ p.get_absolute_url }}">No image</a>
                        {% endif %}
                        <h3 class="name">
                            <a href="{{ p.get_absolute_url }}">{{ p.name }}</a>
                        </h3>

                        {% if p.has_active_discount %}
                            {% include 'discounts/discount_badge.html' with product=p %}
                            <div class="price-old line-through text-gray-400">
                                {{ p.price|currency }}
                            </div>
                            <div class="price-new text-red-600 font-semibold">
                                {{ p.get_discounted_price|currency }}
                            </div>
                        {% else %}
                            <div class="price">
                                {{ p.price|currency }}
                            </div>
                        {% endif %}
                    </article>
                {% endfor %}
            </div>
        </section>
    {% endif %}
{% endblock %}
